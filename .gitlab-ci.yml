workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" || $CI_COMMIT_BRANCH == "main"'
      when: always
    - when: never

default:
  image: python:3.11.4
before_script:
  - apt-get update -qq && apt-get install -y curl
  - curl -L https://fly.io/install.sh | sh
  - export FLYCTL_INSTALL="/root/.fly"
  - export PATH="$FLYCTL_INSTALL/bin:$PATH"
  - python --version
  - pip install virtualenv
  - python -m venv .venv

variables:
  PYTHONPATH: "$CI_PROJECT_DIR"

stages:
  - install
  - test
  - code_quality
  - deploy

install_dependencies:
  stage: install
  script:
    - source .venv/bin/activate
    - pip install -r app/dev-requirements.txt
    - pip install -r app/requirements.txt
    - pip install pre-commit
  rules:
    - changes:
        - Makefile
        - dev-requirements.in
        - requirements.in
        - pyproject.toml
      when: never
    - when: always

test:
  stage: test
  image: python:3.11.4
  script:
    - source .venv/bin/activate
  rules:
    - changes:
        - Makefile
        - dev-requirements.in
        - requirements.in
        - pyproject.toml
      when: never
    - when: always

black:
  stage: code_quality
  script:
    - source .venv/bin/activate
    - pip install pre-commit
    - pre-commit run black --all-files
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" || $CI_COMMIT_BRANCH == "main"'
    - when: always

flake8:
  stage: code_quality
  script:
    - source .venv/bin/activate
    - pip install pre-commit
    - pre-commit run flake8 --all-files
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" || $CI_COMMIT_BRANCH == "main"'
    - when: always

bandit:
  stage: code_quality
  script:
    - source .venv/bin/activate
    - pip install pre-commit
    - pre-commit run bandit --all-files
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" || $CI_COMMIT_BRANCH == "main"'
    - when: always

checkmake:
  image: ubuntu:jammy
  stage: code_quality
  script:
    - source .venv/bin/activate
    - apt-get install -y golang-go
    - export GOROOT=/usr/local/go
    - export GOPATH=$HOME/go
    - export PATH=$GOPATH/bin:$GOROOT/bin:$PATH
    - go version
    - pip install pre-commit
    - pre-commit run --all-files
  rules:
    - if: '$CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "main"'
    - changes:
        - 'Makefile'
        - 'makefile'
        - 'GNUmakefile'
        - '**.mk'
        - '**.make'
      when: always

deploy-prod:
  stage: deploy
  script:
    - echo "Deploy app from $CI_COMMIT_BRANCH branch"
    - flyctl auth token $FLY_API_TOKEN
    - flyctl deploy --ha=false --config app/fly.toml
  environment: production
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"'
    - when: manual
