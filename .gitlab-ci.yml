default:
  image: python:3.11.4
  cache:                      # Pip's cache doesn't store the python packages
    paths:                    # https://pip.pypa.io/en/stable/topics/caching/
      - .cache/pip
before_script:
  - apt-get update -qq && apt-get install -y curl
  - curl -L https://fly.io/install.sh | sh
  - export FLYCTL_INSTALL="/root/.fly"
  - export PATH="$FLYCTL_INSTALL/bin:$PATH"
  - python --version
  - pip install virtualenv
  - python -m venv .venv

variables:  # Change pip's cache directory to be inside the project directory since we can only cache local items.
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  PYTHONPATH: "$CI_PROJECT_DIR"

stages:
  - install
  - test
  - code_quality
  - deploy

install_dependencies:
  stage: install
  script:
    - source .venv/bin/activate
    - pip install -r dev-requirements.txt
    - pip install -r requirements.txt
    - pip install pre-commit
  cache:
    key: "$CI_COMMIT_REF_NAME"
    paths:
      - .venv/
  rules:
    - changes:
        - .gitlab-ci.yml
      when: always
    - changes:
        - Makefile
        - dev-requirements.in
        - requirements.in
        - pyproject.toml
      when: never
    - when: on_success

test:
  stage: test
  script:
    - source .venv/bin/activate
    - python -m pytest
  cache:
    key: "$CI_COMMIT_REF_NAME"
    paths:
      - .venv/
  rules:
    - changes:
        - .gitlab-ci.yml
      when: always
    - changes:
        - Makefile
        - dev-requirements.in
        - requirements.in
        - pyproject.toml
      when: never
    - when: on_success

black:
  stage: code_quality
  script:
    - source .venv/bin/activate
    - pip install pre-commit
    - pre-commit run black --all-files

flake8:
  stage: code_quality
  script:
    - source .venv/bin/activate
    - pip install pre-commit
    - pre-commit run flake8 --all-files

bandit:
  stage: code_quality
  script:
    - source .venv/bin/activate
    - pip install pre-commit
    - pre-commit run bandit --all-files

deploy-prod:
  stage: deploy
  script:
    - echo "Deploy app from $CI_COMMIT_BRANCH branch"
    - flyctl auth token $FLY_API_TOKEN
    - flyctl deploy --ha=false --config app/fly.toml
  environment: production
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"'
      when: always
    - changes:
        - .gitlab-ci.yml
      when: never
    - changes:
        - Makefile
        - dev-requirements.in
        - requirements.in
        - pyproject.toml
      when: never
    - when: manual
